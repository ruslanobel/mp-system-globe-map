# Архитектура проекта MP System Map

## Обзор

MP System Map — это интерактивная глобусная карта для Webflow сайта, использующая Mapbox GL JS. Приложение отображает выделенные страны и офисы на ортографической проекции глобуса с минималистичным дизайном. Карта интегрируется в Webflow через Custom Code и загружается через live server. Особое внимание уделено предотвращению автоматического зумирования при прокрутке к полюсам и ограничению вертикального вращения для стабильного пользовательского опыта.

## Основные компоненты

### MapController
Главный контроллер карты, отвечающий за:
- Инициализацию Mapbox карты с локальным стилем из `style.json`
- Настройку ортографической проекции (pitch = 0, фиксированный zoom)
- Управление интерактивностью (только drag, отключение zoom/rotate)
- Центрирование глобуса в квадратном контейнере
- Предотвращение конфликтов wheel событий между скроллом страницы и картой
- **Ограничение вертикального вращения** (`limitVerticalRotation`) — предотвращает прокрутку к полюсам (latitude: -30° до 30°)
- **Фиксация projection scaler** (`fixProjectionScaler`) — патчит внутреннюю переменную Mapbox для предотвращения автоматического зумирования
- **Предотвращение автоматического zoom** (`preventAutoZoom`) — отслеживает и корректирует изменения zoom и pitch

### CountriesManager
Менеджер стран, отвечающий за:
- Загрузку списка стран из DOM через data-атрибуты (`data-map-country-item`, `data-map-country-iso`)
- Загрузку GeoJSON данных стран из внешних источников (Natural Earth)
- Выделение стран на карте с использованием высокодетализированных границ
- Автоматический выбор источника GeoJSON по качеству (количество координат)

### Конфигурация (CONFIG)
Централизованная конфигурация в `script.js`:
- Пути к ресурсам (стили, GeoJSON источники)
- Настройки визуализации (цвета, прозрачность, обводки)
- Параметры карты (центр на экваторе `[13.4, 0]`, zoom, padding)
- **Ограничения вращения**: `LATITUDE_MIN: -30`, `LATITUDE_MAX: 30`
- Data-атрибуты для связи с DOM

## Поток данных

### Инициализация
1. **DOMContentLoaded** → Загрузка HTML структуры
2. **MapController.init()** → Инициализация карты:
   - Загрузка локального стиля из `style.json` (fallback на Mapbox Studio стиль)
   - Создание Mapbox карты с ортографической проекцией на экваторе (`[13.4, 0]`)
   - Настройка интерактивности и центрирования
   - Применение ограничений вертикального вращения
   - Фиксация projection scaler для предотвращения зумирования
3. **CountriesManager.loadFromDOM()** → Парсинг стран из DOM
4. **CountriesManager.highlightCountries()** → Загрузка GeoJSON и визуализация

### Загрузка данных стран
1. **DOM** → Страны загружаются из HTML через data-атрибуты
2. **GeoJSON источники** → Попытка загрузки из нескольких источников:
   - Natural Earth 10m (максимальная детализация)
   - Natural Earth 50m (баланс)
   - Natural Earth 110m (fallback)
   - GitHub альтернативный источник
3. **Оценка качества** → Выбор источника по количеству координат (минимум 10,000)
4. **Mapbox** → Добавление слоев заливки и обводки для выделения стран

### Управление состоянием
- **Нет глобального state management** — состояние хранится в:
  - DOM элементах (списки стран/офисов)
  - Mapbox внутреннем состоянии (слои, источники)
  - Локальных переменных классов (countries array, map instance)

## Структура директорий

```
Map/
├── script.js              # Основной JavaScript код (MapController, CountriesManager)
├── index.html             # HTML структура с контейнером карты и data-атрибутами
├── style.css              # Стили для карты, tooltip, модальных окон
├── style.json             # Конфигурация стиля Mapbox (локальный стиль глобуса)
├── collections/            # CSV данные для маркеров (не используются напрямую в коде)
│   ├── MP System - Map _ Countries.csv
│   └── MP System - Map _ Offices.csv
├── .cursor/
│   └── docs/
│       └── architecture.md  # Этот файл
└── node_modules/           # Зависимости (если есть)
```

### Описание файлов

- **script.js** — Вся логика приложения: инициализация карты, управление странами, обработка событий, предотвращение зумирования
- **index.html** — HTML структура с контейнером `#globe-map`, скрытыми списками стран/офисов, tooltip и модальными окнами
- **style.css** — Стили для карты, tooltip, модальных окон, пинов офисов
- **style.json** — Локальный стиль Mapbox с минималистичным дизайном (серый фон, простые границы)
- **collections/** — CSV файлы с данными для будущей интеграции (пока не используются)

## Внешние сервисы

### Mapbox GL JS v3.17.0
- **Назначение**: Рендеринг интерактивной карты
- **Использование**: 
  - Создание карты с ортографической проекцией (globe)
  - Добавление слоев для выделения стран
  - Управление интерактивностью (drag, zoom, rotate)
  - Патчинг внутренних переменных (`transform._projectionScaler`) для предотвращения зумирования
- **Токен**: `window.MAPBOX_ACCESS_TOKEN` (определяется в HTML)

### Natural Earth (CloudFront CDN)
- **Назначение**: GeoJSON данные стран с высокой детализацией границ
- **Источники**:
  - `ne_10m_admin_0_countries.geojson` (максимальная детализация)
  - `ne_50m_admin_0_countries.geojson` (баланс)
  - `ne_110m_admin_0_countries.geojson` (fallback)
- **Использование**: Загрузка границ стран для выделения на карте

### jsDelivr CDN
- **Назначение**: Распространение скрипта для Webflow интеграции
- **Использование**: Загрузка `script.js` через GitHub CDN в Webflow Custom Code

### GitHub (альтернативный источник)
- **Назначение**: Fallback источник GeoJSON данных
- **URL**: `https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson`

## Особенности реализации

### Ортографическая проекция
- Фиксированный `pitch = 0` для плоского вида глобуса
- Фиксированный `zoom` на основе ширины контейнера (`zoom = log2(containerWidth / 256)`)
- Отключение всех интерактивных элементов кроме drag
- **Начальная позиция на экваторе** (`[13.4, 0]`) для центрирования Европы без приближения к полюсам

### Предотвращение автоматического зумирования
- **Ограничение вертикального вращения** (`limitVerticalRotation`):
  - Ограничивает latitude в диапазоне от -30° до 30°
  - Перехватывает события `move`, `drag`, `moveend`
  - Автоматически корректирует позицию при выходе за пределы
- **Фиксация projection scaler** (`fixProjectionScaler`):
  - Патчит внутреннюю переменную `transform._projectionScaler` в Mapbox GL JS
  - Устанавливает фиксированное значение `1.0` вместо вычисления на основе широты
  - Использует `Object.defineProperty` или прямое перехватывание через события
  - **Побочный эффект**: Может вызвать артефакты текстуры у полюсов (texture minification)
- **Предотвращение автоматического zoom** (`preventAutoZoom`):
  - Отслеживает изменения zoom и pitch через события `move` и `zoom`
  - Автоматически корректирует отклонения от целевого значения

### Предотвращение конфликтов событий
- Управление `pointer-events` на canvas для предотвращения перехвата wheel событий
- Таймер для включения pointer-events после скролла страницы (2 секунды)
- Включение pointer-events только при активном drag

### Высокодетализированные границы
- Автоматический выбор источника GeoJSON по качеству
- Оценка детализации по количеству координат
- Отключение упрощения геометрии (`tolerance: 0`)

### Интеграция с Webflow
- Загрузка через Custom Code в `<head>` или `<body>`
- Использование data-атрибутов для передачи данных из Webflow CMS
- Скрытые списки стран/офисов в DOM для парсинга

## Технические решения

### Решение проблемы зумирования к полюсам
Проблема: При прокрутке глобуса к полюсам Mapbox автоматически изменяет zoom из-за внутренней переменной `_projectionScaler`, которая вычисляется на основе широты.

Решение реализовано в три этапа:
1. **Ограничение вертикального вращения** — предотвращает приближение к полюсам
2. **Фиксация projection scaler** — патчит внутреннюю переменную Mapbox
3. **Мониторинг и коррекция zoom** — отслеживает и исправляет изменения в реальном времени

Это решение основано на патчинге внутренних переменных Mapbox GL JS и может потребовать обновления при обновлении библиотеки.
